# Debug configuration with aggressive timing (1s heartbeat)
# Tests if batch delay / heartbeat timing is causing the issue
#
# Usage:
#   docker compose -f docker-compose.debug-fast.yml up

services:
  nats:
    image: nats:2.10
    container_name: nats-debug-fast
    ports:
      - "4222:4222"
      - "8222:8222"
    command: ["--jetstream", "--store_dir=/data"]
    volumes:
      - nats-debug-fast-data:/data
    networks:
      - expanso-debug-fast

  orchestrator:
    image: expanso-orchestrator:debug
    container_name: orchestrator-debug-fast
    ports:
      - "9010:9010"
    environment:
      - EXPANSO_LOG_LEVEL=debug
      - EXPANSO_ORCHESTRATOR_SCHEDULER_HOUSEKEEPING_INTERVAL=1s
      - EXPANSO_ORCHESTRATOR_SCHEDULER_REEVALUATION_BATCH_INTERVAL=1s
      - EXPANSO_ORCHESTRATOR_NODE_MANAGER_HEARTBEAT_FREQUENCY=1s
      - EXPANSO_ORCHESTRATOR_NODE_MANAGER_HEARTBEAT_TIMEOUT=3s
    volumes:
      - orchestrator-debug-fast-data:/var/lib/expanso
    depends_on:
      - nats
    networks:
      - expanso-debug-fast
    command: ["serve", "--orchestrator", "--nats-url=nats://nats:4222"]

  edge1:
    image: expanso-edge:debug
    container_name: edge1-debug-fast
    environment:
      - EXPANSO_LOG_LEVEL=debug
      - EXPANSO_COMPUTE_HEARTBEAT_FREQUENCY=1s
    volumes:
      - edge1-debug-fast-data:/var/lib/expanso
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - orchestrator
    networks:
      - expanso-debug-fast
    privileged: true
    command: ["serve", "--compute", "--orchestrators=nats://nats:4222"]

  edge2:
    image: expanso-edge:debug
    container_name: edge2-debug-fast
    environment:
      - EXPANSO_LOG_LEVEL=debug
      - EXPANSO_COMPUTE_HEARTBEAT_FREQUENCY=1s
    volumes:
      - edge2-debug-fast-data:/var/lib/expanso
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - orchestrator
    networks:
      - expanso-debug-fast
    privileged: true
    command: ["serve", "--compute", "--orchestrators=nats://nats:4222"]

networks:
  expanso-debug-fast:
    driver: bridge

volumes:
  nats-debug-fast-data:
  orchestrator-debug-fast-data:
  edge1-debug-fast-data:
  edge2-debug-fast-data:
