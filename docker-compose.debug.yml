# Debug configuration using locally-built instrumented images
# Usage:
#   ./build-debug.sh                              # Build debug images first
#   docker compose -f docker-compose.debug.yml up # Run (no -d, watch logs)

services:
  nats:
    image: nats:2.10
    container_name: nats-debug
    ports:
      - "4222:4222"
      - "8222:8222"
    command: ["--config", "/etc/nats/nats.conf"]
    volumes:
      - nats-debug-data:/data
      - ./config/nats/nats.conf:/etc/nats/nats.conf:ro
    networks:
      - expanso-debug

  orchestrator:
    image: expanso-orchestrator:debug
    container_name: orchestrator-debug
    ports:
      - "9010:9010"
    command: ["run", "--log-level=debug"]
    volumes:
      - orchestrator-debug-data:/var/lib/expanso/orchestrator
      - ./config/orchestrator/orchestrator.yaml:/etc/expanso/orchestrator/config.yaml:ro
    depends_on:
      - nats
    networks:
      - expanso-debug

  edge1:
    image: expanso-edge:debug
    container_name: edge1-debug
    command: ["run", "--log-level=debug"]
    volumes:
      - edge1-debug-data:/var/lib/expanso/edge
      - ./config/edge/edge.yaml:/etc/expanso/edge/config.yaml:ro
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - orchestrator
    networks:
      - expanso-debug
    privileged: true

  edge2:
    image: expanso-edge:debug
    container_name: edge2-debug
    command: ["run", "--log-level=debug"]
    volumes:
      - edge2-debug-data:/var/lib/expanso/edge
      - ./config/edge/edge.yaml:/etc/expanso/edge/config.yaml:ro
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - orchestrator
    networks:
      - expanso-debug
    privileged: true

networks:
  expanso-debug:
    driver: bridge

volumes:
  nats-debug-data:
  orchestrator-debug-data:
  edge1-debug-data:
  edge2-debug-data:
